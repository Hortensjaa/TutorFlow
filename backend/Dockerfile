FROM maven:3.8.4-openjdk-17 AS build
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline

COPY src ./src
RUN mvn clean package -DskipTests

FROM openjdk:17-jdk-slim

WORKDIR /app

COPY --from=build /app/target/TutorFlow-0.0.1-SNAPSHOT.jar .

ARG DATASOURCE_URL
ARG DATABASE_USER
ARG DATABASE_PASSWORD
ARG OAUTH2_CLIENT
ARG OAUTH2_SECRET
ARG STORAGE_ENDPOINT
ARG STORAGE_ID
ARG STORAGE_SECRET
ARG SUPABASE_ROLE
ARG PORT
ARG ALLOWED_ORIGIN

ENV DATASOURCE_URL=${DATASOURCE_URL}
ENV DATABASE_USER=${DATABASE_USER}
ENV DATABASE_PASSWORD=${DATABASE_PASSWORD}
ENV OAUTH2_CLIENT=${OAUTH2_CLIENT}
ENV OAUTH2_SECRET=${OAUTH2_SECRET}
ENV STORAGE_ENDPOINT=${STORAGE_ENDPOINT}
ENV STORAGE_ID=${STORAGE_ID}
ENV STORAGE_SECRET=${STORAGE_SECRET}
ENV SUPABASE_ROLE=${SUPABASE_ROLE}
ENV PORT=${PORT}
ENV ALLOWED_ORIGIN=${ALLOWED_ORIGIN}

# Copy the Google Cloud credentials file
COPY tutorflow-448111-81b00dc0fefa.json /app/credentials.json

# Set the environment variable for Google Application Credentials
ENV GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "/app/TutorFlow-0.0.1-SNAPSHOT.jar"]
